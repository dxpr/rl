<p>This module is included in <a href="https://www.drupal.org/project/dxpr_cms">DXPR CMS</a>.</p>

<blockquote>The <strong>Reinforcement Learning (RL)</strong> module implements A/B testing in the most efficient and effective way possible, minizing lost conversions using machine learning.</blockquote>


<p><strong>Thompson Sampling</strong> is a learning-while-doing method. Each time a visitor lands on your site the algorithm "rolls the dice" based on what it has learned so far. Variants that have performed well roll larger numbers, so they are shown more often, while weak copies still get a small chance to prove themselves. This simple trick means the system can discover winners very quickly without stopping normal traffic.</p>

<p>Traditional A/B tests run for a fixed horizon—say two weeks—during which half your visitors keep seeing the weaker version. Thompson Sampling avoids this waste. As soon as the algorithm has even a little evidence it quietly shifts most traffic to the better variant, saving conversions and shortening the wait for useful insights.</p>

<p>For full details of what goes on behind the curtains check the source code: 
<a href="https://git.drupalcode.org/project/rl/-/blob/1.x/src/Service/ThompsonCalculator.php" target="_blank" rel="noopener">ThompsonCalculator.php</a>.
</p>

<h3>RL Modules</h3>

<ul>
<li><a href="https://www.drupal.org/project/ai_sorting"><strong>AI Sorting</strong></a> - Intelligent content ordering/switching for Drupal Views</li>
</ul>

<h3>Features</h3>

<ul>
<li><strong>Thompson Sampling Algorithm</strong> - Pure PHP implementation</li>
<li><strong>Fast HTTP REST API</strong> - Optimized JSON endpoints for tracking and decisions</li>
<li><strong>Administrative Reports</strong> - Experiment analysis interface</li>
<li><strong>Service-based Architecture</strong> - Extensible design</li>
<li><strong>Data Sovereignty, Privacy First</strong> - No cloud, just Drupal</li>
</ul>

<h3>You need RL if</h3>

<ul>
<li><strong>A/B Testing</strong> - Test content variations</li>
<li><strong>Content Optimization</strong> - Track content engagement</li>
<li><strong>Feature Selection</strong> - Choose features to show users</li>
<li><strong>Recommendations</strong> - Optimize content recommendations</li>
<li><strong>Resource Allocation</strong> - Distribute resources across options</li>
</ul>

<h3>Thompson Sampling</h3>

<p>Unlike traditional A/B testing, Thompson Sampling:</p>

<ul>
<li><strong>Adapts automatically</strong> - Shifts traffic to better options</li>
<li><strong>Handles multiple options</strong> - Works with 2+ variations, even thousands of arms are handled well</li>
<li><strong>Continuous learning</strong> - No fixed test duration</li>
<li><strong>Bayesian approach</strong> - Incorporates uncertainty</li>
</ul>

<div class="note-tip">
  <h4>Prefer a turnkey demo site?</h4>
  <p>Spin up <strong>DXPR CMS</strong>—Drupal pre-configured with DXPR Builder, DXPR Theme, RL (Reinforcement Learning) module, and security best practices.</p>
  <p><a href="https://www.drupal.org/project/dxpr_cms" title="DXPR CMS platform">Get DXPR CMS »</a></p>
</div>

<h3>Installation</h3>

<pre><code>composer require drupal/rl
drush en rl</code></pre>

<h4>Verify rl.php Access</h4>
<p>The RL module includes a <code>.htaccess</code> file that allows direct access to <code>rl.php</code> (following the same pattern as Drupal 11's contrib statistics module). Test that it's working:</p>

<pre><code>curl -X POST -d "action=turns&experiment_id=test&arm_ids=1" http://your-site.com/modules/contrib/rl/rl.php</code></pre>

<p><strong>If the test fails:</strong></p>
<ul>
<li><strong>Apache</strong>: Ensure <code>.htaccess</code> files are processed (<code>AllowOverride All</code>)</li>
<li><strong>Nginx</strong>: Copy the rewrite rules from <code>.htaccess</code> to your server config</li>
<li><strong>Security modules</strong>: Whitelist <code>/modules/contrib/rl/rl.php</code></li>
</ul>

<p>If server policies prevent direct access to <code>rl.php</code>, use the Drupal Routes API instead.</p>

<h3>API</h3>

<pre><code>// Get the experiment manager
$experiment_manager = \Drupal::service('rl.experiment_manager');

// Record a trial (content shown)
$experiment_manager->recordTurn('my-experiment', 'variant-a');

// Record a success (user clicked)
$experiment_manager->recordReward('my-experiment', 'variant-a');

// Get Thompson Sampling scores
$scores = $experiment_manager->getThompsonScores('my-experiment');

// Select the best option
$ts_calculator = \Drupal::service('rl.ts_calculator');
$best_option = $ts_calculator->selectBestArm($scores);

// Override page cache for web components (optional)
$cache_manager = \Drupal::service('rl.cache_manager');
$cache_manager->overridePageCacheIfShorter(60); // 60 seconds
</code></pre>

<h3>HTTP Endpoints</h3>

<h4>rl.php - Direct Endpoint (Recommended)</h4>
<p><strong>Use the direct rl.php endpoint for optimal performance:</strong></p>

<pre><code>// Record turns (trials) - when content is viewed
const formData = new FormData();
formData.append('action', 'turns');
formData.append('experiment_uuid', 'abc123');
formData.append('arm_ids', '1,2,3');
navigator.sendBeacon('/modules/contrib/rl/rl.php', formData);

// Record reward (success) - when user clicks/converts  
const rewardData = new FormData();
rewardData.append('action', 'rewards');
rewardData.append('experiment_uuid', 'abc123');
rewardData.append('arm_id', '1');
navigator.sendBeacon('/modules/contrib/rl/rl.php', rewardData);</code></pre>

<h4>Drupal Routes - Alternative API</h4>
<p><strong>Use only when server security policies prevent direct access to rl.php:</strong></p>
<ul>
<li><code>POST /rl/experiment/{uuid}/turns</code> - Record trials</li>
<li><code>POST /rl/experiment/{uuid}/rewards</code> - Record successes</li>
<li><code>GET /rl/experiment/{uuid}/scores</code> - Get scores</li>
</ul>

<h3>Cache Management</h3>

<p>RL provides optional cache management for web components:</p>

<pre><code>// Override page cache if experiment cache is shorter than site cache
\Drupal::service('rl.cache_manager')->overridePageCacheIfShorter(30);
</code></pre>

<p><strong>How it works:</strong></p>
<ul>
<li>If site cache is 300s and experiment needs 30s → overrides to 30s</li>
<li>If site cache is 60s and experiment needs 300s → leaves at 60s</li>
<li>If site cache is disabled → no override</li>
</ul>

<p><strong>Use cases:</strong></p>
<ul>
<li>Views plugins using RL for content sorting</li>
<li>Blocks displaying A/B tested content</li>
<li>Components needing frequent RL score updates</li>
</ul>

<p><strong>Ready to get started?</strong> Install the module and begin implementing intelligent, adaptive decision-making in your Drupal applications today!</p>

<h3>Resources</h3>
<ul>
  <li><a href="https://everyday-data-science.tigyog.app/a-b-testing" target="_blank" rel="noopener">Free Micro-Course on Thompson Sampling</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Multi-armed_bandit" target="_blank" rel="noopener">Multi-Armed Bandit Problem Wiki</a></li>
  <li><a href="https://www.jstor.org/stable/2332286" target="_blank" rel="noopener">On the Likelihood that One Unknown Probability Exceeds Another in View of the Evidence of Two Samples</a></li>
  <li><a href="https://homes.di.unimi.it/~cesa-bianchi/Pubblicazioni/ml-02.pdf" target="_blank" rel="noopener">Finite-time Analysis of the Multiarmed Bandit
Problem</a></li>
</ul>